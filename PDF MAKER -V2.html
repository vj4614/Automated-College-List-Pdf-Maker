<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional PDF Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; position: relative; }
        .file-drop-zone.dragover { background-color: #f0f9ff; border-color: #3b82f6; }
        .file-drop-zone.uploaded { border-color: #22c55e; background-color: #f0fdf4; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 9999;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }
        .reset-file-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 9999px;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .reset-file-btn:hover {
            background-color: #fecaca;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Student College List PDF Generator</h1>
            <p class="mt-2 text-gray-600">Specially designed for GanitAnk.</p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="upload-section" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Excel File Input -->
                <div class="flex flex-col">
                    <div id="excel-drop-zone" class="file-drop-zone bg-white p-6 rounded-lg shadow-sm text-center flex flex-col items-center justify-center h-full">
                        <button id="reset-excel-btn" class="hidden reset-file-btn" title="Remove files">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls, .csv" multiple>
                        <div id="excel-icon-initial">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7" /></svg>
                        </div>
                        <div id="excel-icon-success" class="hidden">
                            <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <p class="mt-2 font-semibold text-gray-700">Excel Data File(s)</p>
                        <p id="excel-file-name" class="text-sm text-gray-500 mt-1 px-2 break-words">Click or drag & drop</p>
                    </div>
                </div>
                <!-- Template File Input -->
                <div class="flex flex-col">
                    <div id="template-drop-zone" class="file-drop-zone bg-white p-6 rounded-lg shadow-sm text-center flex flex-col items-center justify-center h-full">
                         <button id="reset-template-btn" class="hidden reset-file-btn" title="Remove file">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <input type="file" id="template-file-input" class="hidden" accept=".pdf">
                        <div id="template-icon-initial">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </div>
                        <div id="template-icon-success" class="hidden">
                            <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <p class="mt-2 font-semibold text-gray-700">Base Template PDF</p>
                        <p id="template-file-name" class="text-sm text-gray-500 mt-1 px-2 break-words">Click or drag & drop</p>
                    </div>
                </div>
                <!-- Last Page File Input -->
                <div class="flex flex-col">
                    <div id="last-page-drop-zone" class="file-drop-zone bg-white p-6 rounded-lg shadow-sm text-center flex flex-col items-center justify-center h-full">
                        <button id="reset-last-page-btn" class="hidden reset-file-btn" title="Remove file">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <input type="file" id="last-page-file-input" class="hidden" accept=".pdf">
                        <div id="last-page-icon-initial">
                           <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        </div>
                        <div id="last-page-icon-success" class="hidden">
                            <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <p class="mt-2 font-semibold text-gray-700">Last Page(s) PDF</p>
                        <p id="last-page-file-name" class="text-sm text-gray-500 mt-1 px-2 break-words">Click or drag & drop</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <details>
                    <summary class="font-semibold text-gray-700 cursor-pointer">Advanced Options (Column Mapping)</summary>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4 pt-4 border-t">
                        <div>
                            <label for="profile-label-col" class="block text-sm font-medium text-gray-600">Profile Label Col</label>
                            <input type="text" id="profile-label-col" value="A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-value-col" class="block text-sm font-medium text-gray-600">Profile Value Col</label>
                            <input type="text" id="profile-value-col" value="B" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="college-code-col" class="block text-sm font-medium text-gray-600">College Code Col</label>
                            <input type="text" id="college-code-col" value="A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="college-name-col" class="block text-sm font-medium text-gray-600">College Name Col</label>
                            <input type="text" id="college-name-col" value="B" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                            <div>
                            <label for="branch-col" class="block text-sm font-medium text-gray-600">Branch Name Col</label>
                            <input type="text" id="branch-col" value="C" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Specify the Excel column letter for each data point. For profile data, "Name" must be in the label column.</p>
                </details>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-center gap-4">
                <button id="reset-btn" class="bg-gray-200 text-gray-700 py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    Reset All
                </button>
                <button id="generate-btn" class="bg-blue-600 text-white py-3 px-12 rounded-lg hover:bg-blue-700 transition-colors text-lg font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Generate PDFs
                </button>
            </div>

            <!-- Progress and Results -->
            <div id="progress-section" class="mt-8 hidden">
                <div class="flex items-center justify-center mb-4">
                    <div class="loader h-8 w-8 rounded-full border-4 border-gray-200"></div>
                    <p id="progress-text" class="ml-4 text-lg font-medium text-gray-700">Processing...</p>
                </div>
                <div id="results-container" class="bg-white rounded-lg p-4 shadow-sm max-h-96 overflow-y-auto">
                    <!-- Generated files will be listed here -->
                </div>
                    <div class="text-center mt-4">
                    <button id="download-zip-btn" class="hidden w-full md:w-auto bg-purple-600 text-white py-3 px-12 rounded-lg hover:bg-purple-700 transition-colors text-lg font-semibold">
                        Download All as ZIP
                    </button>
                </div>
            </div>
        </main>
    </div>
    <div id="toast-container"></div>

    <script id="pdf-worker" type="javascript/worker">
        self.importScripts(
            'https://unpkg.com/xlsx/dist/xlsx.full.min.js',
            'https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js'
        );

        // This worker will now process a single student block at a time
        self.onmessage = async (e) => {
            const { studentBlock, baseTemplateBuffer, lastPageBuffer, columnMapping, excelFileName, sheetName } = e.data;
            const { PDFDocument, rgb, StandardFonts } = PDFLib;

            const postLog = (message, type = 'info') => self.postMessage({ type: 'log', message, logType: type });

            try {
                // Load templates for each task, as ArrayBuffers are transferable and can be re-used
                const baseTemplateDoc = await PDFDocument.load(baseTemplateBuffer);
                const lastPageDoc = await PDFDocument.load(lastPageBuffer);

                const sanitize = (text) => String(text || '').replace(/[\r\n\x00-\x1F\x7F-\x9F]/g, "").trim();

                const profileRows = studentBlock.slice(0, 8);
                const collegeRows = studentBlock.slice(9); 

                const profileData = profileRows.map(row => [sanitize(row[columnMapping.profileLabel]), sanitize(row[columnMapping.profileValue])]);
                const studentName = profileData[0] ? profileData[0][1] : 'Unknown';
                const percentile = profileData[2] ? profileData[2][1] : 'N/A';

                if (!studentName || studentName === 'Unknown') {
                    postLog(`⚠️ Skipping a block with no student name in ${excelFileName}, sheet ${sheetName}.`, 'warn');
                    self.postMessage({ type: 'done_student', excelFileName, sheetName, filename: null, bytes: null }); // Indicate completion even if skipped
                    return;
                }
                
                const finalPdfDoc = await PDFDocument.create();
                const helveticaFont = await finalPdfDoc.embedFont(StandardFonts.Helvetica);
                const helveticaBoldFont = await finalPdfDoc.embedFont(StandardFonts.HelveticaBold);

                const collegeList = collegeRows
                    .filter(row => {
                        const collegeCodeValue = String(row[columnMapping.collegeCode] || '').trim().toUpperCase();
                        const collegeNameValue = String(row[columnMapping.collegeName] || '').trim();
                        
                        return collegeCodeValue !== 'CODE' &&
                               collegeCodeValue !== 'COMMENTS' && 
                               collegeNameValue !== '';
                    })
                    .map(row => [sanitize(row[columnMapping.collegeCode]), sanitize(row[columnMapping.collegeName]), sanitize(row[columnMapping.branchName])]);


                const contentPagesInfo = await createContentPages(finalPdfDoc, { profileData, collegeList, studentName }, { helveticaFont, helveticaBoldFont });

                for (const pageInfo of contentPagesInfo) {
                    const [templatePage] = await finalPdfDoc.copyPages(baseTemplateDoc, [0]);
                    const embeddedPage = await finalPdfDoc.embedPage(pageInfo);
                    templatePage.drawPage(embeddedPage, { x: 0, y: 0, width: templatePage.getWidth(), height: templatePage.getHeight() });
                    finalPdfDoc.addPage(templatePage);
                }

                const lastPagesCopied = await finalPdfDoc.copyPages(lastPageDoc, lastPageDoc.getPageIndices());
                for(const page of lastPagesCopied) finalPdfDoc.addPage(page);

                const pdfBytes = await finalPdfDoc.save();
                const cleanName = String(studentName).trim().replace(/_/g, " ");
                const roundedPercentile = isNaN(parseFloat(percentile)) ? percentile : Math.round(parseFloat(percentile) * 100) / 100;
                const filename = `${cleanName} ${roundedPercentile}.pdf`;
                
                // Send back the generated PDF bytes for this single student
                self.postMessage({ type: 'done_student', filename, bytes: pdfBytes, sheetName, excelFileName });
            } catch (error) {
                self.postMessage({ type: 'error_student', message: error.message, excelFileName, sheetName, studentName: studentBlock[0] ? sanitize(studentBlock[0][columnMapping.profileValue]) : 'Unknown' });
            }
        };

        async function createContentPages(doc, data, fonts) {
            const { PDFDocument, rgb } = PDFLib;
            const { profileData, collegeList, studentName } = data;
            const { helveticaFont, helveticaBoldFont } = fonts;
            
            let pages = [];
            let currentDoc = await PDFDocument.create();
            let currentPage = currentDoc.addPage();
            const A4_WIDTH = 595.28;

            const title = `${String(studentName).trim()}'s College List`;
            currentPage.drawText(title, {
                x: (A4_WIDTH - helveticaBoldFont.widthOfTextAtSize(title, 16)) / 2,
                y: 710, font: helveticaBoldFont, size: 16, color: rgb(0, 0.168, 0.360)
            });

            let y = 670;
            const profileBoxInfo = drawProfileBox(currentPage, profileData, y, fonts);
            y = profileBoxInfo.nextY;

            const col_x = [60, 120, 420, 500, 560]; 

            const max_widths = [
                col_x[1] - col_x[0] - 10, 
                col_x[2] - col_x[1] - 40, // College Name column content width (increased right padding to 40)
                col_x[3] - col_x[2] - 10  
            ];
            let prefNo = 1;

            const drawTableHeader = (page, yPos) => {
                const rowHeight = 24;
                page.drawRectangle({ x: col_x[0], y: yPos - rowHeight, width: col_x[4] - col_x[0], height: rowHeight, borderColor: rgb(0,0,0), borderWidth: 1});
                for (let i = 1; i < 4; i++) {
                    page.drawLine({ start: { x: col_x[i], y: yPos }, end: { x: col_x[i], y: yPos - rowHeight }, thickness: 1, color: rgb(0,0,0) });
                }
                const headers = ["Code", "College Name", "Branch", "Pref. No."];
                headers.forEach((header, i) => {
                    let headerX = col_x[i] + 4;
                    if (i === 0) headerX = col_x[0] + (col_x[1] - col_x[0] - helveticaBoldFont.widthOfTextAtSize(headers[0], 11)) / 2; 
                    if (i === 1) headerX = col_x[1] + 4; 
                    if (i === 2) headerX = col_x[2] + 4; 
                    if (i === 3) headerX = col_x[3] + (col_x[4] - col_x[3] - helveticaBoldFont.widthOfTextAtSize(headers[3], 11)) / 2; 

                    page.drawText(header, { x: headerX, y: yPos - 16, font: helveticaBoldFont, size: 11 });
                });
                return yPos - rowHeight;
            };

            y = drawTableHeader(currentPage, y);

            for (const college of collegeList) {
                const [code, clg, br] = college;
                const clgLines = wrapText(clg, max_widths[1], helveticaFont, 10);
                const brLines = wrapText(br, max_widths[2], helveticaFont, 10); 
                const rowHeight = Math.max(clgLines.length, brLines.length) * 14 + 10;
                
                if (y - rowHeight < 80) {
                    pages.push(currentPage);
                    currentPage = currentDoc.addPage();
                    const contdTitle = `${title} (Contd.)`;
                    currentPage.drawText(contdTitle, {
                        x: (A4_WIDTH - helveticaBoldFont.widthOfTextAtSize(contdTitle, 14)) / 2,
                        y: 710, font: helveticaBoldFont, size: 14
                    });
                    y = 690;
                    y = drawTableHeader(currentPage, y);
                }

                currentPage.drawRectangle({ x: col_x[0], y: y - rowHeight, width: col_x[4] - col_x[0], height: rowHeight, borderColor: rgb(0,0,0), borderWidth: 1});
                for (let i = 1; i < 4; i++) {
                    currentPage.drawLine({ start: { x: col_x[i], y: y }, end: { x: col_x[i], y: y - rowHeight }, thickness: 1, color: rgb(0,0,0) });
                }
                
                const codeWidth = helveticaFont.widthOfTextAtSize(String(code), 10);
                currentPage.drawText(String(code), { x: col_x[0] + (col_x[1] - col_x[0] - codeWidth) / 2, y: y - 16, font: helveticaFont, size: 10 });
                
                const prefNoWidth = helveticaFont.widthOfTextAtSize(String(prefNo), 10);
                currentPage.drawText(String(prefNo), { x: col_x[3] + (col_x[4] - col_x[3] - prefNoWidth) / 2, y: y - 16, font: helveticaFont, size: 10 });
                
                clgLines.forEach((line, i) => currentPage.drawText(line, { x: col_x[1] + 10, y: y - 16 - (i * 14), font: helveticaFont, size: 10 }));
                brLines.forEach((line, i) => currentPage.drawText(line, { x: col_x[2] + 10, y: y - 16 - (i * 14), font: helveticaFont, size: 10 })); 

                y -= rowHeight;
                prefNo++;
            }
            
            pages.push(currentPage);
            return await doc.copyPages(currentDoc, currentDoc.getPageIndices());
        }

        function drawProfileBox(page, profileData, yStart, fonts) {
            const { helveticaFont, helveticaBoldFont } = fonts;
            const { rgb } = PDFLib;
            const box_x = 60;
            const box_width = 260;
            const wrap_line_height = 14;
            let y = yStart;
            const label_x = box_x + 10;
            const value_x = box_x + 130;
            const max_value_width = box_x + box_width - value_x - 10;
            
            let wrappedRows = [];
            let totalBoxHeight = 0;

            profileData.forEach(([label, value]) => {
                const valueLines = wrapText(value, max_value_width, helveticaFont, 9);
                const height = Math.max(1, valueLines.length) * wrap_line_height;
                wrappedRows.push({ label, valueLines, height });
                totalBoxHeight += height;
            });

            page.drawRectangle({ x: box_x, y: y - totalBoxHeight, width: box_width, height: totalBoxHeight, borderColor: rgb(0,0,0), borderWidth: 1 });

            let current_y = y;
            wrappedRows.forEach(({ label, valueLines, height }) => {
                if (current_y !== y) {
                    page.drawLine({ start: { x: box_x, y: current_y }, end: { x: box_x + box_width, y: current_y }, thickness: 1, color: rgb(0,0,0) });
                }
                page.drawText(`${String(label)}:`, { x: label_x, y: current_y - 12, font: helveticaBoldFont, size: 9 });
                valueLines.forEach((line, i) => {
                    page.drawText(line, { x: value_x, y: current_y - 12 - (i * wrap_line_height), font: helveticaFont, size: 9 });
                });
                current_y -= height;
            });
            page.drawLine({ start: { x: box_x, y: current_y }, end: { x: box_x + box_width, y: current_y }, thickness: 1, color: rgb(0,0,0) });

            return { nextY: current_y - 20 };
        }

        function wrapText(text, maxWidth, font, fontSize) {
            if (!text) return [''];
            const words = String(text).split(' ');
            let lines = [];
            let currentLine = '';

            for (const word of words) {
                const testLine = currentLine === '' ? word : `${currentLine} ${word}`;
                const width = font.widthOfTextAtSize(testLine, fontSize);
                if (width < maxWidth) {
                    currentLine = testLine;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const fileInputs = {
                excel: { files: [], el: document.getElementById('excel-file-input'), zone: document.getElementById('excel-drop-zone'), nameEl: document.getElementById('excel-file-name'), initialIcon: document.getElementById('excel-icon-initial'), successIcon: document.getElementById('excel-icon-success'), resetBtn: document.getElementById('reset-excel-btn') },
                template: { file: null, el: document.getElementById('template-file-input'), zone: document.getElementById('template-drop-zone'), nameEl: document.getElementById('template-file-name'), initialIcon: document.getElementById('template-icon-initial'), successIcon: document.getElementById('template-icon-success'), resetBtn: document.getElementById('reset-template-btn') },
                lastPage: { file: null, el: document.getElementById('last-page-file-input'), zone: document.getElementById('last-page-drop-zone'), nameEl: document.getElementById('last-page-file-name'), initialIcon: document.getElementById('last-page-icon-initial'), successIcon: document.getElementById('last-page-icon-success'), resetBtn: document.getElementById('reset-last-page-btn') },
            };
            
            const generateBtn = document.getElementById('generate-btn');
            const resetBtn = document.getElementById('reset-btn');
            const progressSection = document.getElementById('progress-section');
            const progressText = document.getElementById('progress-text');
            const resultsContainer = document.getElementById('results-container');
            const downloadZipBtn = document.getElementById('download-zip-btn');
            const toastContainer = document.getElementById('toast-container');

            // --- State Variables ---
            let generatedPdfs = {}; // Object to store PDFs grouped by excel file name
            let totalStudentTasks = 0;
            let completedStudentTasks = 0;
            const workerPool = [];
            const MAX_WORKERS = navigator.hardwareConcurrency || 4;
            let taskQueue = [];
            let baseTemplateBuffer, lastPageBuffer;

            // --- Event Listeners Setup ---
            const setupFileDropZone = (key) => {
                const input = fileInputs[key];
                input.zone.addEventListener('click', () => input.el.click());
                input.el.addEventListener('change', (e) => {
                    if (key === 'excel') handleMultipleFilesSelect(e.target.files);
                    else handleSingleFileSelect(key, e.target.files[0]);
                });
                input.zone.addEventListener('dragover', (e) => { e.preventDefault(); input.zone.classList.add('dragover'); });
                input.zone.addEventListener('dragleave', () => input.zone.classList.remove('dragover'));
                input.zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    input.zone.classList.remove('dragover');
                    if (key === 'excel') handleMultipleFilesSelect(e.dataTransfer.files);
                    else handleSingleFileSelect(key, e.dataTransfer.files[0]);
                });
                input.resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetInput(key);
                });
            };

            Object.keys(fileInputs).forEach(setupFileDropZone);

            generateBtn.addEventListener('click', handleGenerateClick);
            resetBtn.addEventListener('click', resetAll);
            downloadZipBtn.addEventListener('click', handleDownloadZip);

            // --- File Handling ---
            function handleSingleFileSelect(key, file) {
                if (!file) return;
                const input = fileInputs[key];
                input.file = file;
                input.nameEl.textContent = file.name;
                input.zone.classList.add('uploaded');
                input.initialIcon.classList.add('hidden');
                input.successIcon.classList.remove('hidden');
                input.resetBtn.classList.remove('hidden');
                checkAllFilesUploaded();
            }

            function handleMultipleFilesSelect(files) {
                if (files.length === 0) return;
                const input = fileInputs.excel;
                input.files = Array.from(files);
                input.nameEl.textContent = `${input.files.length} file(s) selected`;
                input.zone.classList.add('uploaded');
                input.initialIcon.classList.add('hidden');
                input.successIcon.classList.remove('hidden');
                input.resetBtn.classList.remove('hidden');
                checkAllFilesUploaded();
            }

            function checkAllFilesUploaded() {
                generateBtn.disabled = !(fileInputs.excel.files.length > 0 && fileInputs.template.file && fileInputs.lastPage.file);
            }

            // --- Reset Logic ---
            function resetInput(key) {
                const input = fileInputs[key];
                if (key === 'excel') {
                    input.files = [];
                    input.nameEl.textContent = 'Click or drag & drop';
                } else {
                    input.file = null;
                    input.nameEl.textContent = 'Click or drag & drop';
                }
                input.el.value = '';
                input.zone.classList.remove('uploaded');
                input.initialIcon.classList.remove('hidden');
                input.successIcon.classList.add('hidden');
                input.resetBtn.classList.add('hidden');
                checkAllFilesUploaded();
            }

            function resetAll() {
                workerPool.forEach(worker => worker.terminate());
                workerPool.length = 0;
                Object.keys(fileInputs).forEach(resetInput);
                progressSection.classList.add('hidden');
                resultsContainer.innerHTML = '';
                generatedPdfs = {};
                downloadZipBtn.classList.add('hidden');
                generateBtn.disabled = true;
                totalStudentTasks = 0;
                completedStudentTasks = 0;
                taskQueue = [];
                baseTemplateBuffer = null;
                lastPageBuffer = null;
            }

            // --- Core PDF Generation Logic ---
            function colToIndex(col) {
                let index = 0;
                for (let i = 0; i < col.length; i++) {
                    index = index * 26 + col.toUpperCase().charCodeAt(i) - 64;
                }
                return index - 1;
            }

            async function handleGenerateClick() {
                const columnMapping = {
                    profileLabel: colToIndex(document.getElementById('profile-label-col').value),
                    profileValue: colToIndex(document.getElementById('profile-value-col').value),
                    collegeCode: colToIndex(document.getElementById('college-code-col').value),
                    collegeName: colToIndex(document.getElementById('college-name-col').value),
                    branchName: colToIndex(document.getElementById('branch-col').value)
                };

                if(Object.values(columnMapping).some(v => isNaN(v) || v < 0)) {
                    showToast('Invalid column letter provided. Please use letters like A, B, C.', 'error');
                    return;
                }

                // Prepare UI for generation
                progressSection.classList.remove('hidden');
                generateBtn.disabled = true;
                resetBtn.disabled = true;
                resultsContainer.innerHTML = '';
                generatedPdfs = {}; 
                downloadZipBtn.classList.add('hidden');
                totalStudentTasks = 0;
                completedStudentTasks = 0;
                taskQueue = [];

                // Read PDF templates into memory
                try {
                    addLog('Loading PDF templates...');
                    baseTemplateBuffer = await fileInputs.template.file.arrayBuffer();
                    lastPageBuffer = await fileInputs.lastPage.file.arrayBuffer();
                    addLog('PDF templates loaded successfully.');
                } catch (error) {
                    showToast('Failed to load template PDF files.', 'error');
                    addLog(`Error loading template PDFs: ${error.message}`, 'error');
                    resetBtn.disabled = false;
                    generateBtn.disabled = false;
                    progressSection.classList.add('hidden');
                    return;
                }

                // Parse Excel files and create tasks
                for (const excelFile of fileInputs.excel.files) {
                    addLog(`Parsing Excel file: ${excelFile.name}...`);
                    try {
                        const workbook = XLSX.read(await excelFile.arrayBuffer(), { type: 'array' });
                        for (const sheetName of workbook.SheetNames) {
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                            let studentBlocks = [];
                            let currentBlock = [];
                            for (const row of json) {
                                if (row[columnMapping.profileLabel] && String(row[columnMapping.profileLabel]).trim().toLowerCase() === "name") {
                                    if (currentBlock.length > 0) studentBlocks.push(currentBlock);
                                    currentBlock = [row];
                                } else if (currentBlock.length > 0) {
                                    currentBlock.push(row);
                                }
                            }
                            if (currentBlock.length > 0) studentBlocks.push(currentBlock);
                            
                            addLog(`Found ${studentBlocks.length} student blocks in sheet: ${sheetName}.`);
                            studentBlocks.forEach(studentBlock => {
                                taskQueue.push({
                                    studentBlock,
                                    baseTemplateBuffer: baseTemplateBuffer.slice(0), // Pass a copy
                                    lastPageBuffer: lastPageBuffer.slice(0), // Pass a copy
                                    columnMapping,
                                    excelFileName: excelFile.name,
                                    sheetName
                                });
                            });
                        }
                    } catch (error) {
                        showToast(`Error parsing Excel file ${excelFile.name}: ${error.message}`, 'error');
                        addLog(`Error parsing Excel file ${excelFile.name}: ${error.message}`, 'error');
                    }
                }
                
                totalStudentTasks = taskQueue.length;
                if (totalStudentTasks === 0) {
                    showToast('No valid student data found to process.', 'warn');
                    progressText.textContent = 'No data to process.';
                    resetBtn.disabled = false;
                    generateBtn.disabled = false;
                    return;
                }

                progressText.textContent = `Starting PDF generation for ${totalStudentTasks} students...`;
                processTaskQueue();
            }

            // --- Web Worker Management ---
            function processTaskQueue() {
                while (taskQueue.length > 0 && workerPool.length < MAX_WORKERS) {
                    const task = taskQueue.shift();
                    const worker = new Worker(URL.createObjectURL(new Blob([document.getElementById('pdf-worker').textContent], { type: 'application/javascript' })));
                    workerPool.push(worker);

                    worker.onmessage = (e) => handleWorkerMessage(e, worker);
                    worker.onerror = (e) => {
                        showToast(`A critical worker error occurred: ${e.message}`, 'error');
                        addLog(`Worker Error: ${e.message}`, 'error');
                        const workerIndex = workerPool.indexOf(worker);
                        if (workerIndex > -1) workerPool.splice(workerIndex, 1);
                        worker.terminate();
                        processTaskQueue();
                    };

                    // Post message with transferable objects for performance
                    worker.postMessage(task, [task.baseTemplateBuffer, task.lastPageBuffer]);
                }
            }

            function handleWorkerMessage(e, worker) {
                const { type, message, logType, filename, bytes, sheetName, excelFileName } = e.data;
                
                switch (type) {
                    case 'log':
                        addLog(message, logType);
                        break;
                    case 'done_student':
                    case 'error_student':
                        completedStudentTasks++;
                        
                        if (type === 'done_student' && filename && bytes) {
                            if (!generatedPdfs[excelFileName]) {
                                generatedPdfs[excelFileName] = [];
                            }
                            generatedPdfs[excelFileName].push({ filename, bytes, sheetName });
                            addResultFile(filename, bytes, excelFileName, sheetName);
                        } else if (type === 'error_student') {
                            const studentId = e.data.studentName || 'Unknown';
                            const errorMsg = `Error for student '${studentId}' from ${excelFileName} (Sheet: ${sheetName}): ${message}`;
                            showToast(errorMsg, 'error');
                            addLog(errorMsg, 'error');
                        }

                        progressText.textContent = `Processing: ${completedStudentTasks}/${totalStudentTasks} student PDFs generated.`;

                        // Free up the worker and process the next task
                        const workerIndex = workerPool.indexOf(worker);
                        if (workerIndex > -1) workerPool.splice(workerIndex, 1);
                        worker.terminate();
                        processTaskQueue();

                        // Check for completion
                        if (completedStudentTasks === totalStudentTasks) {
                            progressText.textContent = 'All PDF Generations Complete!';
                            if(Object.keys(generatedPdfs).length > 0) downloadZipBtn.classList.remove('hidden');
                            resetBtn.disabled = false;
                        }
                        break;
                }
            }
            
            // --- UI Update Functions ---
            function addLog(message, type = 'info') {
                const p = document.createElement('p');
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                if (type === 'success') p.className = 'text-green-600';
                if (type === 'error') p.className = 'text-red-600 font-medium';
                if (type === 'warn') p.className = 'text-yellow-600';
                resultsContainer.appendChild(p);
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }

            function addResultFile(filename, bytes, excelFileName, sheetName) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 border-b';
                
                const p = document.createElement('p');
                p.className = 'text-sm text-gray-700 truncate mr-2';
                p.textContent = `${excelFileName} (${sheetName}) / ${filename}`; 
                p.title = `${excelFileName} (${sheetName}) / ${filename}`;
                
                const button = document.createElement('button');
                button.className = 'flex-shrink-0 text-sm bg-blue-500 text-white py-1 px-3 rounded-md hover:bg-blue-600 transition-colors';
                button.textContent = 'Download';
                button.onclick = () => {
                    const blob = new Blob([new Uint8Array(bytes)], { type: 'application/pdf' });
                    saveAs(blob, filename);
                };

                div.appendChild(p);
                div.appendChild(button);
                resultsContainer.appendChild(div);
            }
            
            function handleDownloadZip() {
                const zip = new JSZip();
                
                for (const excelFileName in generatedPdfs) {
                    if (generatedPdfs.hasOwnProperty(excelFileName)) {
                        const folderName = excelFileName.replace(/\.xlsx|\.xls|\.csv/i, ''); 
                        const folder = zip.folder(folderName);
                        generatedPdfs[excelFileName].forEach(({ filename, bytes }) => {
                            folder.file(filename, bytes);
                        });
                    }
                }

                zip.generateAsync({ type: 'blob' }).then((blob) => {
                    saveAs(blob, `Ganitank_All_Reports_${new Date().toISOString().slice(0,10)}.zip`);
                });
            }

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast show ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 5000);
                }, 5000);
            }
        });
    </script>
</body>
</html>
